#
# Application OpenSearch schema.
#
# All fields are dynamic. Most metadata elements are indexed as text
# (t_element_*) except for those with a date input type, which are indexed as
# dates (d_element_*).
#
# The t_* (text) type includes a keyword subfield to support faceting, as well
# as a sort subfield to support sorting. The sort subfield uses the
# icu_collation_keyword type to support a natural sort order (e.g. 9, 10, 11
# vs. 10, 11, 9). Note that the presence of these subfields limits the maximum
# length of the text type to 32 KB. Text values larger than this should be
# stored in longtext fields (lt_*) instead.
#
# Currently the search_all field is populated but not actually used. Instead, a
# similar lt_all_elements field is written into the document that enables
# support for simple cross-field search queries--for example, "author title"--
# without containing a bunch of irrelevant non-metadata text like search_all
# does.
#
# Maximum document size depends on AWS OpenSearch instance size, which for
# us is probably 10 MB. Large fields must be truncated to less than this
# length, with enough room left over for the rest of the document.
#
# When this file is changed, a new index has to be created (see the
# OpenSearch:indexes:* rake tasks) and then either the old index must be copied
# into it ("reindexed" in ES terminology--if possible) or else all documents
# must be resubmitted to it.
#
# Requires OpenSearch >= 1.0 with the analysis-icu plugin
#
settings:
  index:
    query:
      default_field: search_all
    max_result_window: 10000 # must match OpenSearchIndex::MAX_RESULT_WINDOW
    refresh_interval: 30s
  analysis:
    filter:
      custom_stopper:
        type: stop
        stopwords:
          - _english_
      english_stemmer:
        type: stemmer
        language: english
      possessive_stemmer:
        type: stemmer
        language: possessive_english
    analyzer:
      custom_analyzer:
        tokenizer: standard
        filter:
          - possessive_stemmer
          - lowercase
          - custom_stopper
          - english_stemmer
          - decimal_digit
mappings:
  date_detection: false
  dynamic_templates:
    - booleans:
        match: b_*
        mapping:
          type: boolean
          store: false
    - dates:
        match: d_*
        mapping:
          type: date
          store: false
    - geo_points:
        match: p_*
        mapping:
          type: geo_point
          store: false
    - integers:
        match: i_*
        mapping:
          type: integer
          store: false
    - keywords:
        match: k_*
        mapping:
          type: keyword
          fields:
            keyword:
              type: keyword
            sort:
              type: icu_collation_keyword
              index: false
              numeric: true
              language: en
              strength: quaternary
              alternate: shifted
    - longs:
        match: l_*
        mapping:
          type: long
          store: false
    # This is a special text field for long text values (like full text)
    # because the other text type has a keyword subfield that is limited to
    # 32 KB.
    - longtext:
        match: lt_*
        mapping:
          type: text
          analyzer: custom_analyzer
          copy_to: search_all
          store: false
    - text:
        match: t_*
        mapping:
          type: text
          analyzer: custom_analyzer
          copy_to: search_all
          store: false
          fields:
            keyword:
              type: keyword
            sort:
              type: icu_collation_keyword
              index: false
              numeric: true
              language: en
              strength: quaternary
              alternate: shifted
  properties:
    search_all:
      type: text
      analyzer: custom_analyzer
      store: false